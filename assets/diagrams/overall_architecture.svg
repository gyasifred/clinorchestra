<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1400 1600" width="1400" height="1600">
  <defs>
    <style>
      .title { font: bold 32px sans-serif; fill: #1a1a1a; }
      .subtitle { font: bold 20px sans-serif; fill: #333; }
      .layer-title { font: bold 18px sans-serif; fill: #fff; }
      .component-title { font: bold 14px sans-serif; fill: #1a1a1a; }
      .component-text { font: 12px sans-serif; fill: #333; }
      .label { font: 11px sans-serif; fill: #666; }
      .arrow { stroke: #555; stroke-width: 2; fill: none; marker-end: url(#arrowhead); }
      .arrow-bidirectional { stroke: #555; stroke-width: 2; fill: none; marker-end: url(#arrowhead); marker-start: url(#arrowhead-reverse); }
      .dashed-arrow { stroke: #888; stroke-width: 2; fill: none; stroke-dasharray: 5,5; marker-end: url(#arrowhead); }

      .ui-layer { fill: #3498db; }
      .state-layer { fill: #2ecc71; }
      .agent-layer { fill: #e74c3c; }
      .core-layer { fill: #f39c12; }
      .tools-layer { fill: #9b59b6; }
      .optimization-layer { fill: #16a085; }

      .component-box { fill: #fff; stroke: #333; stroke-width: 2; rx: 8; }
      .sub-component { fill: #f8f9fa; stroke: #666; stroke-width: 1.5; rx: 6; }
    </style>

    <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#555" />
    </marker>
    <marker id="arrowhead-reverse" markerWidth="10" markerHeight="10" refX="1" refY="3" orient="auto">
      <polygon points="10 0, 0 3, 10 6" fill="#555" />
    </marker>
  </defs>

  <!-- Title -->
  <text x="700" y="40" text-anchor="middle" class="title">ClinOrchestra System Architecture</text>
  <text x="700" y="70" text-anchor="middle" class="subtitle">Universal Clinical Data Extraction Platform v1.0.0</text>

  <!-- Layer 1: User Interface -->
  <rect x="50" y="100" width="1300" height="150" class="ui-layer" rx="10"/>
  <text x="700" y="125" text-anchor="middle" class="layer-title">Layer 1: Web Interface (Gradio UI)</text>

  <!-- UI Components -->
  <rect x="80" y="140" width="150" height="90" class="component-box"/>
  <text x="155" y="165" text-anchor="middle" class="component-title">Model Config</text>
  <text x="155" y="185" text-anchor="middle" class="label">• Provider</text>
  <text x="155" y="200" text-anchor="middle" class="label">• API Keys</text>
  <text x="155" y="215" text-anchor="middle" class="label">• Temperature</text>

  <rect x="250" y="140" width="150" height="90" class="component-box"/>
  <text x="325" y="165" text-anchor="middle" class="component-title">Prompt Config</text>
  <text x="325" y="185" text-anchor="middle" class="label">• Main Prompt</text>
  <text x="325" y="200" text-anchor="middle" class="label">• JSON Schema</text>
  <text x="325" y="215" text-anchor="middle" class="label">• RAG Settings</text>

  <rect x="420" y="140" width="150" height="90" class="component-box"/>
  <text x="495" y="165" text-anchor="middle" class="component-title">Data Upload</text>
  <text x="495" y="185" text-anchor="middle" class="label">• CSV Import</text>
  <text x="495" y="200" text-anchor="middle" class="label">• Column Map</text>
  <text x="495" y="215" text-anchor="middle" class="label">• Labels</text>

  <rect x="590" y="140" width="150" height="90" class="component-box"/>
  <text x="665" y="165" text-anchor="middle" class="component-title">Tools Config</text>
  <text x="665" y="185" text-anchor="middle" class="label">• Functions</text>
  <text x="665" y="200" text-anchor="middle" class="label">• Patterns</text>
  <text x="665" y="215" text-anchor="middle" class="label">• Extras</text>

  <rect x="760" y="140" width="150" height="90" class="component-box"/>
  <text x="835" y="165" text-anchor="middle" class="component-title">RAG Tab</text>
  <text x="835" y="185" text-anchor="middle" class="label">• Documents</text>
  <text x="835" y="200" text-anchor="middle" class="label">• Embeddings</text>
  <text x="835" y="215" text-anchor="middle" class="label">• K-value</text>

  <rect x="930" y="140" width="150" height="90" class="component-box"/>
  <text x="1005" y="165" text-anchor="middle" class="component-title">Playground</text>
  <text x="1005" y="185" text-anchor="middle" class="label">• Single Test</text>
  <text x="1005" y="200" text-anchor="middle" class="label">• Live Results</text>
  <text x="1005" y="215" text-anchor="middle" class="label">• Debugging</text>

  <rect x="1100" y="140" width="150" height="90" class="component-box"/>
  <text x="1175" y="165" text-anchor="middle" class="component-title">Processing</text>
  <text x="1175" y="185" text-anchor="middle" class="label">• Batch Run</text>
  <text x="1175" y="200" text-anchor="middle" class="label">• Progress</text>
  <text x="1175" y="215" text-anchor="middle" class="label">• Export</text>

  <!-- Layer 2: Application State -->
  <rect x="50" y="280" width="1300" height="120" class="state-layer" rx="10"/>
  <text x="700" y="305" text-anchor="middle" class="layer-title">Layer 2: Application State (Central Configuration Manager)</text>

  <rect x="100" y="320" width="200" height="65" class="component-box"/>
  <text x="200" y="340" text-anchor="middle" class="component-title">ModelConfig</text>
  <text x="200" y="360" text-anchor="middle" class="label">Provider, Model, API Key</text>
  <text x="200" y="375" text-anchor="middle" class="label">Temperature, Max Tokens</text>

  <rect x="320" y="320" width="200" height="65" class="component-box"/>
  <text x="420" y="340" text-anchor="middle" class="component-title">PromptConfig</text>
  <text x="420" y="360" text-anchor="middle" class="label">Main/Minimal Prompts</text>
  <text x="420" y="375" text-anchor="middle" class="label">JSON Schema, RAG Prompt</text>

  <rect x="540" y="320" width="200" height="65" class="component-box"/>
  <text x="640" y="340" text-anchor="middle" class="component-title">DataConfig</text>
  <text x="640" y="360" text-anchor="middle" class="label">Text Column, Labels</text>
  <text x="640" y="375" text-anchor="middle" class="label">Prompt Variables, PHI</text>

  <rect x="760" y="320" width="200" height="65" class="component-box"/>
  <text x="860" y="340" text-anchor="middle" class="component-title">RAGConfig</text>
  <text x="860" y="360" text-anchor="middle" class="label">Documents, Embeddings</text>
  <text x="860" y="375" text-anchor="middle" class="label">Chunk Size, K-value</text>

  <rect x="980" y="320" width="250" height="65" class="component-box"/>
  <text x="1105" y="340" text-anchor="middle" class="component-title">OptimizationConfig</text>
  <text x="1105" y="360" text-anchor="middle" class="label">Cache, Parallel, Multi-GPU</text>
  <text x="1105" y="375" text-anchor="middle" class="label">Batch Preprocessing</text>

  <!-- Arrows from UI to State -->
  <path d="M 155 230 L 155 260 L 200 320" class="arrow"/>
  <path d="M 325 230 L 325 260 L 420 320" class="arrow"/>
  <path d="M 495 230 L 495 260 L 640 320" class="arrow"/>
  <path d="M 665 230 L 665 260 L 860 320" class="arrow"/>
  <path d="M 1175 230 L 1175 260 L 1105 320" class="arrow"/>

  <!-- Layer 3: Extraction Engines -->
  <rect x="50" y="430" width="1300" height="180" class="agent-layer" rx="10"/>
  <text x="700" y="455" text-anchor="middle" class="layer-title">Layer 3: Extraction Engines (Dual Execution Modes)</text>

  <!-- Agent Factory -->
  <rect x="580" y="470" width="240" height="50" class="component-box"/>
  <text x="700" y="490" text-anchor="middle" class="component-title">Agent Factory</text>
  <text x="700" y="505" text-anchor="middle" class="label">Creates agents based on configuration</text>

  <!-- STRUCTURED Mode -->
  <rect x="100" y="540" width="520" height="55" class="component-box"/>
  <text x="360" y="560" text-anchor="middle" class="component-title">STRUCTURED Mode (ExtractionAgent)</text>
  <text x="180" y="580" text-anchor="middle" class="label">Stage 1: Analyze</text>
  <text x="300" y="580" text-anchor="middle" class="label">Stage 2: Tools</text>
  <text x="420" y="580" text-anchor="middle" class="label">Stage 3: Extract</text>
  <text x="540" y="580" text-anchor="middle" class="label">Stage 4: Refine</text>

  <!-- ADAPTIVE Mode -->
  <rect x="660" y="540" width="590" height="55" class="component-box"/>
  <text x="955" y="560" text-anchor="middle" class="component-title">ADAPTIVE Mode (AgenticAgent)</text>
  <text x="755" y="580" text-anchor="middle" class="label">1. Analyze</text>
  <text x="855" y="580" text-anchor="middle" class="label">2. Decide</text>
  <text x="955" y="580" text-anchor="middle" class="label">3. Execute Tools</text>
  <text x="1070" y="580" text-anchor="middle" class="label">4. Iterate</text>
  <text x="1180" y="580" text-anchor="middle" class="label">5. Complete</text>

  <!-- Arrow from State to Agents -->
  <path d="M 700 385 L 700 470" class="arrow"/>

  <!-- Layer 4: Core Services -->
  <rect x="50" y="640" width="1300" height="200" class="core-layer" rx="10"/>
  <text x="700" y="665" text-anchor="middle" class="layer-title">Layer 4: Core Services (LLM Integration & Knowledge Retrieval)</text>

  <!-- LLM Manager -->
  <rect x="100" y="690" width="360" height="130" class="component-box"/>
  <text x="280" y="710" text-anchor="middle" class="component-title">LLM Manager</text>

  <rect x="120" y="725" width="100" height="40" class="sub-component"/>
  <text x="170" y="745" text-anchor="middle" class="label">OpenAI</text>
  <text x="170" y="758" text-anchor="middle" class="label" font-size="9">GPT-4, GPT-4o</text>

  <rect x="230" y="725" width="100" height="40" class="sub-component"/>
  <text x="280" y="745" text-anchor="middle" class="label">Anthropic</text>
  <text x="280" y="758" text-anchor="middle" class="label" font-size="9">Claude 3.5</text>

  <rect x="340" y="725" width="100" height="40" class="sub-component"/>
  <text x="390" y="745" text-anchor="middle" class="label">Google</text>
  <text x="390" y="758" text-anchor="middle" class="label" font-size="9">Gemini 1.5</text>

  <rect x="120" y="775" width="100" height="35" class="sub-component"/>
  <text x="170" y="795" text-anchor="middle" class="label">Azure</text>

  <rect x="230" y="775" width="210" height="35" class="sub-component"/>
  <text x="335" y="795" text-anchor="middle" class="label">Local (Unsloth)</text>
  <text x="335" y="805" text-anchor="middle" class="label" font-size="9">Llama, Phi, Qwen, Mistral</text>

  <!-- RAG Engine -->
  <rect x="490" y="690" width="420" height="130" class="component-box"/>
  <text x="700" y="710" text-anchor="middle" class="component-title">RAG Engine (Knowledge Retrieval)</text>

  <rect x="510" y="725" width="180" height="40" class="sub-component"/>
  <text x="600" y="740" text-anchor="middle" class="label">Document Ingestion</text>
  <text x="600" y="755" text-anchor="middle" class="label" font-size="9">PDF, URL, Text</text>

  <rect x="510" y="775" width="180" height="35" class="sub-component"/>
  <text x="600" y="795" text-anchor="middle" class="label">Chunking & Embedding</text>

  <rect x="710" y="725" width="180" height="40" class="sub-component"/>
  <text x="800" y="740" text-anchor="middle" class="label">Vector Search (FAISS)</text>
  <text x="800" y="755" text-anchor="middle" class="label" font-size="9">Cosine Similarity</text>

  <rect x="710" y="775" width="180" height="35" class="sub-component"/>
  <text x="800" y="795" text-anchor="middle" class="label">Top-K Retrieval</text>

  <!-- Preprocessing -->
  <rect x="940" y="690" width="310" height="130" class="component-box"/>
  <text x="1095" y="710" text-anchor="middle" class="component-title">Text Preprocessing</text>

  <rect x="960" y="725" width="135" height="40" class="sub-component"/>
  <text x="1027" y="740" text-anchor="middle" class="label">PHI Redaction</text>
  <text x="1027" y="755" text-anchor="middle" class="label" font-size="9">Dates, Names, IDs</text>

  <rect x="1105" y="725" width="125" height="40" class="sub-component"/>
  <text x="1167" y="740" text-anchor="middle" class="label">Pattern Norm.</text>
  <text x="1167" y="755" text-anchor="middle" class="label" font-size="9">Regex Rules</text>

  <rect x="960" y="775" width="270" height="35" class="sub-component"/>
  <text x="1095" y="795" text-anchor="middle" class="label">Batch Preprocessing (15-25% faster)</text>

  <!-- Arrows from Agents to Core -->
  <path d="M 280 595 L 280 690" class="arrow"/>
  <path d="M 700 595 L 700 690" class="arrow"/>
  <path d="M 1095 595 L 1095 690" class="arrow"/>

  <!-- Layer 5: Tool Systems -->
  <rect x="50" y="870" width="1300" height="240" class="tools-layer" rx="10"/>
  <text x="700" y="895" text-anchor="middle" class="layer-title">Layer 5: Tool Systems (Domain Knowledge & Medical Functions)</text>

  <!-- Function Registry -->
  <rect x="100" y="920" width="360" height="170" class="component-box"/>
  <text x="280" y="940" text-anchor="middle" class="component-title">Function Registry (40+ Functions)</text>

  <rect x="120" y="960" width="155" height="40" class="sub-component"/>
  <text x="197" y="975" text-anchor="middle" class="label">Anthropometry</text>
  <text x="197" y="990" text-anchor="middle" class="label" font-size="9">BMI, BSA, IBW, Z-scores</text>

  <rect x="285" y="960" width="155" height="40" class="sub-component"/>
  <text x="362" y="975" text-anchor="middle" class="label">Clinical Scores</text>
  <text x="362" y="990" text-anchor="middle" class="label" font-size="9">HEART, TIMI, PHQ-9</text>

  <rect x="120" y="1010" width="155" height="40" class="sub-component"/>
  <text x="197" y="1025" text-anchor="middle" class="label">Lab Calculations</text>
  <text x="197" y="1040" text-anchor="middle" class="label" font-size="9">Corrected Ca, CrCl</text>

  <rect x="285" y="1010" width="155" height="40" class="sub-component"/>
  <text x="362" y="1025" text-anchor="middle" class="label">Unit Conversions</text>
  <text x="362" y="1040" text-anchor="middle" class="label" font-size="9">kg/lbs, cm/inches</text>

  <rect x="120" y="1060" width="320" height="20" class="sub-component"/>
  <text x="280" y="1073" text-anchor="middle" class="label" font-size="9">Thread-safe, Composable, Recursive-safe</text>

  <!-- Regex Preprocessor -->
  <rect x="490" y="920" width="260" height="170" class="component-box"/>
  <text x="620" y="940" text-anchor="middle" class="component-title">Patterns (33+ Rules)</text>

  <rect x="510" y="960" width="220" height="30" class="sub-component"/>
  <text x="620" y="978" text-anchor="middle" class="label">Vital Signs: BP, HR, RR, SpO2</text>

  <rect x="510" y="1000" width="220" height="30" class="sub-component"/>
  <text x="620" y="1018" text-anchor="middle" class="label">Lab Values: Glucose, HbA1c</text>

  <rect x="510" y="1040" width="220" height="30" class="sub-component"/>
  <text x="620" y="1058" text-anchor="middle" class="label">Medications: Dosing, Routes</text>

  <!-- Extras Manager -->
  <rect x="780" y="920" width="470" height="170" class="component-box"/>
  <text x="1015" y="940" text-anchor="middle" class="component-title">Extras Manager (49+ Clinical Hints)</text>

  <rect x="800" y="960" width="200" height="30" class="sub-component"/>
  <text x="900" y="978" text-anchor="middle" class="label">Growth Standards (WHO, CDC)</text>

  <rect x="1010" y="960" width="220" height="30" class="sub-component"/>
  <text x="1120" y="978" text-anchor="middle" class="label">Malnutrition Criteria (ASPEN)</text>

  <rect x="800" y="1000" width="200" height="30" class="sub-component"/>
  <text x="900" y="1018" text-anchor="middle" class="label">Diagnostic Criteria</text>

  <rect x="1010" y="1000" width="220" height="30" class="sub-component"/>
  <text x="1120" y="1018" text-anchor="middle" class="label">Assessment Scales</text>

  <rect x="800" y="1040" width="430" height="40" class="sub-component"/>
  <text x="1015" y="1055" text-anchor="middle" class="label">Keyword-Based Matching</text>
  <text x="1015" y="1070" text-anchor="middle" class="label" font-size="9">Matches schema fields & task requirements (NOT input text)</text>

  <!-- Arrows from Core to Tools -->
  <path d="M 280 840 L 280 920" class="dashed-arrow"/>
  <path d="M 620 840 L 620 920" class="dashed-arrow"/>
  <path d="M 1015 840 L 1015 920" class="dashed-arrow"/>

  <!-- Layer 6: Optimization & Performance -->
  <rect x="50" y="1140" width="1300" height="160" class="optimization-layer" rx="10"/>
  <text x="700" y="1165" text-anchor="middle" class="layer-title">Layer 6: Optimization & Performance (Production-Ready Features)</text>

  <!-- LLM Cache -->
  <rect x="100" y="1190" width="250" height="90" class="component-box"/>
  <text x="225" y="1210" text-anchor="middle" class="component-title">LLM Response Cache</text>
  <text x="225" y="1230" text-anchor="middle" class="label">SQLite Database</text>
  <text x="225" y="1245" text-anchor="middle" class="label">400x Faster on Hits</text>
  <text x="225" y="1260" text-anchor="middle" class="label">Auto-Invalidation</text>
  <text x="225" y="1275" text-anchor="middle" class="label" font-size="10">Hash: prompt + model + config</text>

  <!-- Parallel Processor -->
  <rect x="370" y="1190" width="300" height="90" class="component-box"/>
  <text x="520" y="1210" text-anchor="middle" class="component-title">Parallel Processing</text>
  <text x="470" y="1235" text-anchor="middle" class="label">ThreadPoolExecutor</text>
  <text x="470" y="1255" text-anchor="middle" class="label" font-size="10">(Cloud APIs)</text>
  <text x="470" y="1270" text-anchor="middle" class="label" font-size="10">5-10x speedup</text>

  <text x="590" y="1235" text-anchor="middle" class="label">ProcessPoolExecutor</text>
  <text x="590" y="1255" text-anchor="middle" class="label" font-size="10">(Local Multi-GPU)</text>
  <text x="590" y="1270" text-anchor="middle" class="label" font-size="10">2-4x speedup</text>

  <!-- Adaptive Retry -->
  <rect x="690" y="1190" width="280" height="90" class="component-box"/>
  <text x="830" y="1210" text-anchor="middle" class="component-title">Adaptive Retry System</text>
  <text x="830" y="1230" text-anchor="middle" class="label">Progressive Context Reduction</text>
  <text x="830" y="1245" text-anchor="middle" class="label">100% → 80% → 60% → 40% → 20%</text>
  <text x="830" y="1260" text-anchor="middle" class="label">Minimal Prompt Fallback</text>
  <text x="830" y="1275" text-anchor="middle" class="label" font-size="10">Exponential Backoff</text>

  <!-- Performance Monitor -->
  <rect x="990" y="1190" width="260" height="90" class="component-box"/>
  <text x="1120" y="1210" text-anchor="middle" class="component-title">Performance Monitoring</text>
  <text x="1120" y="1230" text-anchor="middle" class="label">Operation Timing</text>
  <text x="1120" y="1245" text-anchor="middle" class="label">Metrics Collection</text>
  <text x="1120" y="1260" text-anchor="middle" class="label">Retry Analytics</text>
  <text x="1120" y="1275" text-anchor="middle" class="label" font-size="10">Tool Call Tracking</text>

  <!-- Data Flow Indicators -->
  <text x="50" y="1340" class="component-title">Data Flow:</text>
  <path d="M 150 1335 L 220 1335" class="arrow"/>
  <text x="230" y="1340" class="label">Primary Flow</text>

  <path d="M 350 1335 L 420 1335" class="dashed-arrow"/>
  <text x="430" y="1340" class="label">Tool Access</text>

  <path d="M 550 1335 L 620 1335" class="arrow-bidirectional"/>
  <text x="630" y="1340" class="label">Bidirectional</text>

  <!-- Design Choices Box -->
  <rect x="50" y="1360" width="650" height="210" class="component-box" stroke="#2c3e50" stroke-width="3"/>
  <text x="375" y="1385" text-anchor="middle" class="component-title" font-size="16">Key Design Choices</text>

  <text x="70" y="1410" class="label" font-weight="bold">1. Universal Platform:</text>
  <text x="90" y="1430" class="label">• No task-specific hardcoding - adapts via prompts & schemas</text>
  <text x="90" y="1445" class="label">• Examples (malnutrition, MIMIC-IV) show capability, not limits</text>

  <text x="70" y="1470" class="label" font-weight="bold">2. Dual Execution Modes:</text>
  <text x="90" y="1490" class="label">• STRUCTURED: Predictable 4-stage pipeline (production-ready)</text>
  <text x="90" y="1505" class="label">• ADAPTIVE: Iterative autonomous loop (complex cases)</text>

  <text x="70" y="1530" class="label" font-weight="bold">3. Performance First:</text>
  <text x="90" y="1550" class="label">• 400x cache speedup, 60-75% async tool execution gains</text>

  <!-- Architecture Patterns Box -->
  <rect x="720" y="1360" width="630" height="210" class="component-box" stroke="#2c3e50" stroke-width="3"/>
  <text x="1035" y="1385" text-anchor="middle" class="component-title" font-size="16">Architecture Patterns</text>

  <text x="740" y="1410" class="label" font-weight="bold">• Observer Pattern:</text>
  <text x="760" y="1425" class="label">AppState → UI reactive updates</text>

  <text x="740" y="1450" class="label" font-weight="bold">• Factory Pattern:</text>
  <text x="760" y="1465" class="label">Agent creation (STRUCTURED vs ADAPTIVE)</text>

  <text x="740" y="1490" class="label" font-weight="bold">• Strategy Pattern:</text>
  <text x="760" y="1505" class="label">Execution mode selection at runtime</text>

  <text x="740" y="1530" class="label" font-weight="bold">• Plugin Pattern:</text>
  <text x="760" y="1545" class="label">Functions, Patterns, Extras (hot-reload)</text>

  <text x="1010" y="1410" class="label" font-weight="bold">• Adapter Pattern:</text>
  <text x="1030" y="1425" class="label">Unified LLM interface</text>

  <text x="1010" y="1450" class="label" font-weight="bold">• Singleton Pattern:</text>
  <text x="1030" y="1465" class="label">Cache, Monitor instances</text>

  <text x="1010" y="1490" class="label" font-weight="bold">• Repository Pattern:</text>
  <text x="1030" y="1505" class="label">Tool data access abstraction</text>

  <text x="1010" y="1530" class="label" font-weight="bold">• Lazy Initialization:</text>
  <text x="1030" y="1545" class="label">Components load on demand</text>
</svg>
